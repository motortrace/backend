generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Profile - extends Supabase auth.users
// Only stores additional profile data, not identity data
model UserProfile {
  id             String        @id @default(cuid())
  supabaseUserId String        @unique @db.Uuid // Links to auth.users.id (FK constraint added via migration)
  name           String?
  phone          String?
  profileImage   String?
  isRegistrationComplete Boolean @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  customer       Customer?
}

model StaffMember {
  id             String        @id @default(cuid())
  supabaseUserId String        @unique @db.Uuid // Links to auth.users.id (FK constraint added via migration)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  workOrders     WorkOrder[]   @relation("TechnicianWorkOrders")
  advisorWorkOrders WorkOrder[] @relation("AdvisorWorkOrders")
  appointments   Appointment[] @relation("CreatedAppointments")
  assignedAppointments Appointment[] @relation("AssignedAppointments")
  inspections    WorkOrderInspection[] @relation("Inspections")
  createdEstimates WorkOrderEstimate[] @relation("CreatedEstimates")
  approvedEstimates WorkOrderEstimate[] @relation("ApprovedEstimates")
  approvals      WorkOrderApproval[] @relation("Approvals")
  labourItems     WorkOrderLabour[] @relation("LabourWork")
  partInstallations WorkOrderPart[] @relation("PartInstallations")
}

// Customer table supports both app users and walk-ins
// For app users: userProfileId points to their UserProfile
// For walk-ins: userProfileId is NULL
model Customer {
  id            String        @id @default(cuid())
  userProfile   UserProfile?  @relation(fields: [userProfileId], references: [id])
  userProfileId String?       @unique // Nullable to support walk-ins
  name          String        @db.VarChar(255)
  email         String?       // Optional for walk-ins, not unique to allow duplicates
  phone         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  vehicles      Vehicle[]
  workOrders    WorkOrder[]
  appointments  Appointment[]
}

model Vehicle {
  id           String        @id @default(cuid())
  customer     Customer      @relation(fields: [customerId], references: [id])
  customerId   String
  make         String
  model        String
  year         Int?
  vin          String?       @unique
  licensePlate String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  workOrders   WorkOrder[]
  appointments Appointment[]
}

model WorkOrder {
  id              String         @id @default(cuid())
  workOrderNumber String         @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  customer        Customer       @relation(fields: [customerId], references: [id])
  customerId      String
  vehicle         Vehicle        @relation(fields: [vehicleId], references: [id])
  vehicleId       String

  appointment     Appointment?   @relation(fields: [appointmentId], references: [id])
  appointmentId   String?

  serviceAdvisor  StaffMember?   @relation("AdvisorWorkOrders", fields: [advisorId], references: [id])
  advisorId       String?
  technician      StaffMember?   @relation("TechnicianWorkOrders", fields: [technicianId], references: [id])
  technicianId    String?

  status          WorkOrderStatus
  jobType         JobType        @default(REPAIR)
  priority        JobPriority    @default(NORMAL)
  source          JobSource      @default(WALK_IN)
  complaint       String?
  odometerReading Int?
  warrantyStatus  WarrantyStatus @default(NONE)

  estimatedTotal  Decimal?       @db.Decimal(10,2)
  estimateNotes   String?
  estimateApproved Boolean       @default(false)

  subtotalLabour  Decimal?       @db.Decimal(10,2)
  subtotalParts   Decimal?       @db.Decimal(10,2)
  discountAmount  Decimal?       @db.Decimal(10,2)
  taxAmount       Decimal?       @db.Decimal(10,2)
  totalAmount     Decimal?       @db.Decimal(10,2)
  paidAmount      Decimal?       @db.Decimal(10,2) @default(0)

  // Relations to be defined
  serviceItems    ServiceItem[]
  inspections     WorkOrderInspection[]
  labourItems     WorkOrderLabour[]
  partsUsed       WorkOrderPart[]
  approvals       WorkOrderApproval[]
  qcChecks        WorkOrderQC[]
  attachments     WorkOrderAttachment[]
  payments        Payment[]
}

model ServiceCatalog {
  id          String         @id @default(cuid())
  code        String         @unique
  name        String
  description String?
  standardCost Decimal       
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  serviceItems ServiceItem[]
  partsUsed    WorkOrderPart[]
}

model ServiceItem {
  id               String          @id @default(cuid())
  workOrder        WorkOrder       @relation(fields: [workOrderId], references: [id])
  workOrderId      String
  serviceCatalog   ServiceCatalog? @relation(fields: [serviceCatalogId], references: [id])
  serviceCatalogId String?
  description      String
  cost             Decimal         
  createdAt        DateTime        @default(now())
}

model InventoryItem {
  id          String        @id @default(cuid())
  name        String
  sku         String?       @unique
  quantity    Int           @default(0)
  unitPrice   Decimal       
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

enum UserRole {
  CUSTOMER
  ADMIN
  MANAGER
  SERVICE_ADVISOR
  INVENTORY_MANAGER
  TECHNICIAN
}

enum StaffRole {
  ADMIN
  MANAGER
  SERVICE_ADVISOR
  INVENTORY_MANAGER
  TECHNICIAN
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  WAITING_FOR_PARTS
  QC_PENDING
  COMPLETED
  CANCELLED
}

enum JobType {
  REPAIR
  MAINTENANCE
  INSPECTION
  WARRANTY
  RECALL
}

enum JobPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum JobSource {
  WALK_IN
  APPOINTMENT
  PHONE
  ROADSIDE_ASSIST
}

enum WarrantyStatus {
  NONE
  MANUFACTURER
  EXTENDED
}

// Appointment management
model Appointment {
  id           String            @id @default(cuid())
  customer     Customer          @relation(fields: [customerId], references: [id])
  customerId   String
  vehicle      Vehicle           @relation(fields: [vehicleId], references: [id])
  vehicleId    String
  requestedAt  DateTime
  startTime    DateTime?
  endTime      DateTime?
  status       AppointmentStatus @default(PENDING)
  notes        String?
  serviceType  String?           // e.g., "Oil Change", "Brake Inspection", "General Service"
  priority     AppointmentPriority @default(NORMAL)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  // Relations
  workOrder    WorkOrder?
  createdBy    StaffMember?      @relation("CreatedAppointments", fields: [createdById], references: [id])
  createdById  String?
  assignedTo   StaffMember?      @relation("AssignedAppointments", fields: [assignedToId], references: [id])
  assignedToId String?
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Inspection & Diagnostic Reports
model WorkOrderInspection {
  id           String     @id @default(cuid())
  workOrder    WorkOrder  @relation(fields: [workOrderId], references: [id])
  workOrderId  String
  inspector    StaffMember @relation("Inspections", fields: [inspectorId], references: [id])
  inspectorId  String
  date         DateTime   @default(now())
  notes        String?
  
  // Relations
  checklistItems InspectionChecklistItem[]
  tireChecks    TireInspection[]
  attachments   WorkOrderInspectionAttachment[]
}

model InspectionChecklistItem {
  id           String     @id @default(cuid())
  inspection   WorkOrderInspection @relation(fields: [inspectionId], references: [id])
  inspectionId String
  category     String     // e.g., "Engine", "Brakes", "Electrical", "Safety"
  item         String     // e.g., "Oil Level", "Brake Pads", "Battery"
  status       ChecklistStatus
  notes        String?    // Additional notes for the item
  createdAt    DateTime   @default(now())
}

enum ChecklistStatus {
  GREEN    // Good condition
  YELLOW   // Needs attention
  RED      // Critical issue
}

model TireInspection {
  id           String     @id @default(cuid())
  inspection   WorkOrderInspection @relation(fields: [inspectionId], references: [id])
  inspectionId String
  position     TirePosition
  brand        String?    // Tire brand
  model        String?    // Tire model
  size         String?    // Tire size (e.g., "205/55R16")
  psi          Int?       // Current PSI
  treadDepth   Decimal?   @db.Decimal(4,2) // Tread depth in mm
  damageNotes  String?    // Any damage or wear notes
  createdAt    DateTime   @default(now())
}

enum TirePosition {
  LF      // Left Front
  RF      // Right Front
  LR      // Left Rear
  RR      // Right Rear
  SPARE   // Spare Tire
}

model WorkOrderInspectionAttachment {
  id           String     @id @default(cuid())
  inspection   WorkOrderInspection @relation(fields: [inspectionId], references: [id])
  inspectionId String
  fileUrl      String
  fileName     String?    // Original filename
  fileType     String?    // e.g., "image/jpeg", "application/pdf"
  fileSize     Int?       // File size in bytes
  description  String?    // Description of what the attachment shows
  uploadedAt   DateTime   @default(now())
}

// Estimates & Approvals
model WorkOrderEstimate {
  id           String    @id @default(cuid())
  workOrder    WorkOrder @relation(fields: [workOrderId], references: [id])
  workOrderId  String
  version      Int       @default(1) // Track estimate versions
  description  String?   // Brief description of what this estimate covers
  totalAmount  Decimal   @db.Decimal(10,2)
  labourAmount Decimal?  @db.Decimal(10,2) // Labour portion
  partsAmount  Decimal?  @db.Decimal(10,2) // Parts portion
  taxAmount    Decimal?  @db.Decimal(10,2) // Tax amount
  discountAmount Decimal? @db.Decimal(10,2) // Any discounts
  notes        String?   // Additional notes about the estimate
  createdBy    StaffMember? @relation("CreatedEstimates", fields: [createdById], references: [id])
  createdById  String?
  createdAt    DateTime  @default(now())
  approved     Boolean   @default(false)
  approvedAt   DateTime?
  approvedBy   StaffMember? @relation("ApprovedEstimates", fields: [approvedById], references: [id])
  approvedById String?
  
  // Relations
  estimateItems WorkOrderEstimateItem[]
}

model WorkOrderEstimateItem {
  id           String    @id @default(cuid())
  estimate     WorkOrderEstimate @relation(fields: [estimateId], references: [id])
  estimateId   String
  description  String    // Item description
  quantity     Int       @default(1)
  unitPrice    Decimal   @db.Decimal(10,2)
  totalPrice   Decimal   @db.Decimal(10,2)
  itemType     EstimateItemType @default(LABOUR)
  notes        String?   // Additional notes for this item
  createdAt    DateTime  @default(now())
}

enum EstimateItemType {
  LABOUR
  PART
  SERVICE
  OTHER
}

model WorkOrderApproval {
  id           String       @id @default(cuid())
  workOrder    WorkOrder    @relation(fields: [workOrderId], references: [id])
  workOrderId  String
  estimate     WorkOrderEstimate? @relation(fields: [estimateId], references: [id])
  estimateId   String?
  status       ApprovalStatus
  requestedAt  DateTime     @default(now())
  approvedAt   DateTime?
  approvedBy   StaffMember? @relation("Approvals", fields: [approvedById], references: [id])
  approvedById String?
  method       ApprovalMethod?
  notes        String?      // Notes from the approval process
  customerSignature String? // URL to signature file or signature data
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

enum ApprovalStatus {
  PENDING
  APPROVED
  DECLINED
  EXPIRED
}

enum ApprovalMethod {
  IN_PERSON
  PHONE
  EMAIL
  APP
  SMS
  DIGITAL_SIGNATURE
}

// Labour & Parts Usage
model WorkOrderLabour {
  id           String     @id @default(cuid())
  workOrder    WorkOrder  @relation(fields: [workOrderId], references: [id])
  workOrderId  String
  description  String     // Description of the labour performed
  hours        Decimal    @db.Decimal(5,2) // Hours worked (e.g., 2.5 hours)
  rate         Decimal    @db.Decimal(10,2) // Hourly rate
  technician   StaffMember? @relation("LabourWork", fields: [technicianId], references: [id])
  technicianId String?
  subtotal     Decimal    @db.Decimal(10,2) // hours * rate
  startTime    DateTime?  // When the work started
  endTime      DateTime?  // When the work ended
  notes        String?    // Additional notes about the labour
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model WorkOrderPart {
  id               String        @id @default(cuid())
  workOrder        WorkOrder     @relation(fields: [workOrderId], references: [id])
  workOrderId      String
  part             InventoryItem @relation(fields: [inventoryItemId], references: [id])
  inventoryItemId  String
  quantity         Int           @default(1)
  unitPrice        Decimal       @db.Decimal(10,2) // Price at time of use
  subtotal         Decimal       @db.Decimal(10,2) // quantity * unitPrice
  source           PartSource    @default(INVENTORY)
  supplierName     String?       // Supplier name if not from inventory
  supplierInvoice  String?       // Supplier invoice number
  warrantyInfo     String?       // Warranty information for the part
  notes            String?       // Additional notes about the part usage
  installedAt      DateTime?     // When the part was installed
  installedBy      StaffMember?  @relation("PartInstallations", fields: [installedById], references: [id])
  installedById    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

enum PartSource {
  INVENTORY        // From shop inventory
  SUPPLIER         // Ordered from supplier
  CUSTOMER_SUPPLIED // Customer provided the part
  WARRANTY         // Warranty replacement
  SALVAGE          // Used/salvage part
}
